#Set Params
param
(
    [Parameter(Mandatory)][String]$configFilePath,
    [Parameter(Mandatory)][String]$databaseName,
    [Parameter(Mandatory)][System.Management.Automation.PSCredential]$sqlServiceCredential
)

#Unpack Configuration Settings
$configurationSettings = Get-Content $configFilePath | Out-String | ConvertFrom-Json

#Set Global Variables
$azureSubscriptionId = $configurationSettings.azureSubscriptionId
$azureUserManagedIdentityId = $configurationSettings.azureUserManagedIdentityId
$azureRecoveryServicesVaultName = $configurationSettings.azureRecoveryServicesVaultName
$azureRecoveryServicesVaultResourceGroupName = $configurationSettings.azureRecoveryServicesVaultResourceGroupName
$azureRecoveryServicesVault = (Get-AzRecoveryServicesVault -ResourceGroupName $azureRecoveryServicesVaultResourceGroupName -Name $azureRecoveryServicesVaultName).ID
$databaseRestoreDirectory = $configurationSettings.databaseRestoreDirectory
$logDirectory = ('C:\Process\DB-Restore\Log')
$scriptLogFileName = ('dbrestore-'+ (Get-Date -Format "yyyy-MM-dd-HH-mm") + "-$databaseName-Log.txt")
$scriptLogPath = "$logDirectory\$scriptLogFileName"
$sourceInstance = $configurationSettings.sourceInstance
$sourceInstanceCode = $configurationSettings.sourceInstanceCode
$targetInstance = $configurationSettings.targetInstance
$targetSQLInstanceNameLocalIdentity = $configurationSettings.targetSQLInstanceNameLocalIdentity
$azureContext = (Connect-AzAccount -Identity -AccountId $azureUserManagedIdentityId).context
$azureContext = Set-AzContext -Subscription $azureSubscriptionId -DefaultProfile $azureContext

#Create Log File
$currentTimestamp = Get-Date
New-Item -Path $logDirectory -Name $scriptLogFileName -ItemType File -Value "Script log file created at $currentTimestamp for '$scheduleType' schedule." -Force

#Set Restore Target Information
try
{
    $targetContainer = Get-AzRecoveryServicesBackupContainer -ContainerType 'AzureVMAppContainer' -VaultId $azureRecoveryServicesVault -FriendlyName $targetInstance
    $currentTimestamp = Get-Date
    $outputText = "The target backup container for '$targetInstance' was successfully retrieved from Azure Recovery Services on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when retrieving the backup container for '$targetInstance' from Azure Recovery Services on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

#Download backup item from Recovery Services Vault
try
{
    $databaseBackupItem = Get-AzRecoveryServicesBackupItem -BackupManagementType 'AzureWorkload' -WorkloadType 'MSSQL' -VaultId $azureRecoveryServicesVault | Where-Object {$_.ServerName -eq $sourceInstance} | Where-Object {$_.Name -eq ("SQLDataBase;$sourceInstanceCode;$databaseName")}
    $currentTimestamp = Get-Date
    $outputText = "Backup item '$sourceInstance;$databaseName' was successfully retrieved from Azure Recovery Services on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when retrieving the backup item '$sourceInstance;$databaseName' from Azure Recovery Services on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

try
{
    $databaseRecoveryPointHistory = Get-AzRecoveryServicesBackupRecoveryPoint -Item $databaseBackupItem -VaultId $azureRecoveryServicesVault | Where-Object {$_.RecoveryPointType -eq 'Full'}
    $currentTimestamp = Get-Date
    $outputText = "Backup item recovery point (Full Backup) for '$sourceInstance;$databaseName' was successfully retrieved from Azure Recovery Services on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when retrieving the backup item recovery point history (Full Backup) for '$sourceInstance;$databaseName' from Azure Recovery Services on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

try
{
    $databaseRecoveryPoint = $databaseRecoveryPointHistory | Group-Object -Property 'ItemName' | ForEach-Object {$_.Group | Sort-Object 'RecoveryPointTime' -Descending | Select-Object -First 1}
    $currentTimestamp = Get-Date
    $outputText = "The most recent backup item recovery point (Full Backup) for '$sourceInstance;$databaseName' was successfully retrieved on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when retrieving the most recent backup item recovery point (Full Backup) for '$sourceInstance;$databaseName' on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

try
{
    $databaseRecoveryPointIdFilter = ('*' + $databaseRecoveryPoint.RecoveryPointId + '*')
    $currentTimestamp = Get-Date
    $outputText = "The recovery point filter for '$sourceInstance;$databaseName' was successfully created as $databaseRecoveryPointIdFilter on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when creating the recovery point filter for '$sourceInstance;$databaseName' on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

try
{
    $databaseRestore = Get-AzRecoveryServicesBackupWorkloadRecoveryConfig -RecoveryPoint $databaseRecoveryPoint -RestoreAsFiles -FilePath $databaseRestoreDirectory -VaultId $azureRecoveryServicesVault -TargetContainer $targetContainer
    $currentTimestamp = Get-Date
    $outputText = "The recovery configuration for '$sourceInstance;$databaseName' was successfully created on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when creating the recovery configuration for '$sourceInstance;$databaseName' on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

try
{
    $backupItemOperation = Restore-AzRecoveryServicesBackupItem -WLRecoveryConfig $databaseRestore -VaultId $azureRecoveryServicesVault
    $backupItemJobId = ($backupItemOperation).JobId
    $backupItemJobArray = Get-AzRecoveryServicesBackupJob -Status InProgress -VaultId $azureRecoveryServicesVault | Where-Object {$_.JobId -eq $backupItemJobId}
    Wait-AzRecoveryServicesBackupJob -Job $backupItemJobArray -VaultId $azureRecoveryServicesVault -Timeout 10800
    $currentTimestamp = Get-Date
    $outputText = "The database '$databaseName' backup file was successfully downloaded to '$databaseRestoreDirectory' from Azure Recovery Services on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when downloading the backup file for '$databaseName' from Azure Recovery Services on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

#Restore backup file to Database Engine

try
{
    $databaseBackupFileToRestore = (Get-ChildItem -Path $databaseRestoreDirectory | Where-Object {$_.Name -like $databaseRecoveryPointIdFilter} | Where-Object {$_.Name -like '*.bak'}).Name
    $currentTimestamp = Get-Date
    $outputText = "The database '$databaseName' backup file is '$databaseBackupFileToRestore' on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when selecting the backup file for '$databaseName' on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

try
{
    $databaseBackupFullPath = ($databaseRestoreDirectory + '\' + $databaseBackupFileToRestore)
    $currentTimestamp = Get-Date
    $outputText = "The database '$databaseName' backup filepath is '$databaseBackupFullPath' on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when computing the full path for the backup file for '$databaseName' on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

try
{
    Import-Module SqlServer
    $currentTimestamp = Get-Date
    $outputText = "The PowerShell module 'SqlServer' has been imported on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when importing the PowerShell module 'SqlServer' on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

try
{
    Restore-SqlDatabase `
    -AutoRelocateFile `
    -BackupFile $databaseBackupFullPath `
    -Credential $sqlServiceCredential `
    -Database $databaseName `
    -ReplaceDatabase `
    -ServerInstance $targetSQLInstanceNameLocalIdentity
    $currentTimestamp = Get-Date
    $outputText = "The database '$databaseName' has been successfully restored to '$targetSQLInstanceNameLocalIdentity' on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $errorMessageDetail = $_.Exception.InnerException.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when restoring the database '$databaseName' to '$targetSQLInstanceNameLocalIdentity' on $env:computername at $currentTimestamp with the following error '$errorMessage $errorMessageDetail'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

#Remove backup files
try
{
    Get-ChildItem -Path $databaseRestoreDirectory | Where-Object {$_.Name -like $databaseRecoveryPointIdFilter} | Remove-Item
    $currentTimestamp = Get-Date
    $outputText = "The backup files for '$databaseName' have been successfully removed from '$databaseRestoreDirectory' on $env:computername at $currentTimestamp."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}
catch
{
    $errorMessage = $_.Exception.Message
    $currentTimestamp = Get-Date
    $outputText = "An error occured when removing the backup files for '$databaseName' from '$databaseRestoreDirectory' on $env:computername at $currentTimestamp with the following error '$errorMessage'."
    Write-Host $outputText
    Add-Content -Path $scriptLogPath "`n$outputText"
}

$currentTimestamp = Get-Date
$outputText = "Execution of db-restore-individual-database.ps1 for '$databaseName' successfully completed on $env:computername at $currentTimestamp."
Write-Host $outputText
Add-Content -Path $scriptLogPath "`n$outputText"